<!DOCTYPE html>

{% load static %}

<html>
<head>
    <meta charset='utf-8' />
    <title>{{ title }}</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel='stylesheet' />
    <link href="{% static "map/map.css" %}" rel='stylesheet' />
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
    <div id='map'></div>

    <div id="o-wrapper" class="o-wrapper">
      <div class="c-buttons">
        <button id="c-button--slide-right" class="c-button">Custom map</button>
      </div>
    </div>

    <nav id="c-menu--slide-right" class="c-menu c-menu--slide-right">
        <button class="c-menu__close">&larr; Close Menu</button>
        <button id="myBtn" class="c-menu__add-layer">Add layer</button>
        <ul class="c-menu__items">
            <li class="c-menu__item">
                <input id='all' type='checkbox' name='rtoggle' value='all' checked='checked'>
                <label for='all'>all</label>
            </li>
            {% for item in list_item %}
                <li class="c-menu__item">
                    <input id='{{ item }}' type='checkbox' name='rtoggle' value='{{ item }}' checked='checked'>
                    <label for='{{ item }}'>{{ item }}</label>
                </li>
            {% endfor %}
        </ul>
    </nav>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">×</span>
            <h2>Upload your layer</h2>
            <hr>
            <form id="form_upload" action="/upload" method="POST">
                <p id="require">« You need to select a file. »</p>
                <input type="text" name="layerName" id="layerName" class="input-text" placeholder="Layer name" required />
                <input type="file" name="fileGeoJSON" id="fileGeoJSON" class="inputfile input-design" accept=".json" required />
                <label for="fileGeoJSON"><span>Choose a file with the geometry</label>
                <input id="form_submit_input" class="tp-button input-design" type="submit" value="Envoyer" />
                <label for="form_submit_input"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="17" viewBox="0 0 20 17"><path d="M10 0l-5.2 4.9h3.3v5.1h3.8v-5.1h3.3l-5.2-4.9zm9.3 11.5l-3.2-2.1h-2l3.4 2.6h-3.5c-.1 0-.2.1-.2.1l-.8 2.3h-6l-.8-2.2c-.1-.1-.1-.2-.2-.2h-3.6l3.4-2.6h-2l-3.2 2.1c-.4.3-.7 1-.6 1.5l.6 3.1c.1.5.7.9 1.2.9h16.3c.6 0 1.1-.4 1.3-.9l.6-3.1c.1-.5-.2-1.2-.7-1.5z"/></svg></label>
            </form>
        </div>
    </div>

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
    <script src="https://code.jquery.com/jquery-3.1.0.js" integrity="sha256-slogkvB1K3VOkzAI8QITxV3VzpOnkeNVsKvtkYLMjfk=" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/ui/1.12.0/jquery-ui.js" integrity="sha256-0YPKAwZP7Mp3ALMRVB2i8GXeEndvCq3eSl/WsAl1Ryk=" crossorigin="anonymous"></script>
    <script src="http://malsup.github.io/jquery.form.js"></script>
    <script>
        // Creation of the Mapbox map
        mapboxgl.accessToken = '{{ mapboxAccessToken }}';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'style',
            center: {{ startingPosition }}, // starting position
            zoom: {{ startingZoom }} // starting zoom
        });

        // Add the navigations controls
        map.addControl(new mapboxgl.Navigation({position: 'top-left'}));

        // Ajax request to get the style file
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'http://{{ django_host }}:{{ django_port }}/style');
        xhr.send(null);
        xhr.onreadystatechange = function () {
          var DONE = 4;
          var OK = 200;
          if (xhr.readyState === DONE) {
            if (xhr.status === OK) {
              jsonStyle = JSON.parse(xhr.responseText);

              var layerList = document.getElementById('c-menu--slide-right');
              var inputs = layerList.getElementsByTagName('input');

              allLayers = jsonStyle.layers;
              allLayersId = [];
              allLayersSources = [];

              // Recovery of all the layers id and source-layer
              for (var i = 1; i < allLayers.length; i++) {
                  allLayersId[i] = allLayers[i]['id'];
                  allLayersSources[i] = allLayers[i]['source-layer'];
              }

              allLayersSourcesAndId = [[]];
              nameLayersSources = [];

              // Add into one list for each source-layer all the id of it
              // Add the name of all the source-layer into one list
              for (var i = 0; i < allLayersId.length; i++) {
                  if (typeof allLayersSourcesAndId[allLayersSources[i]] == 'undefined') {
                      nameLayersSources.push(allLayersSources[i]);
                      allLayersSourcesAndId[allLayersSources[i]] = [allLayersId[i]];
                  }
                  else {
                      allLayersSourcesAndId[allLayersSources[i]].push(allLayersId[i]);
                  }
              }

              // Ajax request for the multiple-style file
              xhrMultipleStyle = new XMLHttpRequest();
              xhrMultipleStyle.open('GET', 'http://{{ django_host }}:{{ django_port }}/multiple-style');
              xhrMultipleStyle.send(null);
              xhrMultipleStyle.onreadystatechange = function () {
                var DONEMultipleStyle = 4;
                var OKMultipleStyle = 200;
                if (xhrMultipleStyle.readyState === DONEMultipleStyle) {
                  if (xhrMultipleStyle.status === OKMultipleStyle) {
                      jsonMultipleStyle = JSON.parse(xhrMultipleStyle.responseText);
                      // Add the other style only if 'multiple_style' is true
                      if (jsonMultipleStyle.multiple_style === true) {
                          map.on('load', function () {
                            // Add of all sources
                            for (var i = 0; i < Object.keys(jsonMultipleStyle.sources).length; i++) {
                                map.addSource(Object.keys(jsonMultipleStyle.sources)[i], {
                                    type: jsonMultipleStyle.sources[Object.keys(jsonMultipleStyle.sources)[i]]["type"],
                                    tiles: jsonMultipleStyle.sources[Object.keys(jsonMultipleStyle.sources)[i]]["tiles"],
                                    maxzoom: jsonMultipleStyle.sources[Object.keys(jsonMultipleStyle.sources)[i]]["maxzoom"],
                                    minzoom: jsonMultipleStyle.sources[Object.keys(jsonMultipleStyle.sources)[i]]["minzoom"]
                                });
                            }
                            // Add of all layers

                            for (var y of jsonMultipleStyle.layers) {
                                var newObject = {};
                                for (var z of Object.keys(y)) {
                                    if (z !== "before") newObject[z] = y[z];
                                }

                                map.addLayer(newObject, y['before']);

                                // Add into one list for each source-layer all the id of it
                                // Add the name of all the source-layer into one list
                                if (typeof y['source-layer'] != 'undefined') {
                                    if (typeof allLayersSourcesAndId[y['source-layer']] == 'undefined') {
                                        nameLayersSources.push(y['source-layer']);
                                        allLayersSourcesAndId[y['source-layer']] = [y['id']];
                                    }
                                    else {
                                        allLayersSourcesAndId[y['source-layer']].push(y['id']);
                                    }
                                }
                            }
                        });
                      }
                  }
                }
              }

              for (var i = 0; i < inputs.length; i++) {
                  // When you click on a checkbox
                  inputs[i].onclick = function (e) {
                      var id = e.path[0].id;
                      idList = [];

                      // If its not the all checkbox
                      if (id != 'all') {
                          idList = allLayersSourcesAndId[id];
                          if (inputs[0].checked == true) {
                              inputs[0].checked = false;
                          }
                          nbInputChecked = 0;
                          for (var w = 1; w < nameLayersSources.length; w++) {
                              if (inputs[w].checked == true){
                                  nbInputChecked++;
                              }
                          }
                          if (nbInputChecked == nameLayersSources.length - 1) {
                              inputs[0].checked = true;
                          }
                      } else {
                          for (var y = 1; y < nameLayersSources.length; y++) {
                              for (var z = 0; z < allLayersSourcesAndId[nameLayersSources[y]].length; z++) {
                                  idList.push(allLayersSourcesAndId[nameLayersSources[y]][z]);
                              }
                              if (inputs[0].checked == false) {
                                  inputs[y].checked = false;
                              } else {
                                  inputs[y].checked = true;
                              }
                          }
                      }

                      // To change the visibility of the layer
                      idList.forEach(function(id2) {
                          var visibility = map.getLayoutProperty(id2, 'visibility');

                          if (id != 'all') {
                              if (visibility === 'none') {
                                  this.className = 'active';
                                  map.setLayoutProperty(id2, 'visibility', 'visible');
                              }
                              else {
                                  map.setLayoutProperty(id2, 'visibility', 'none');
                                  this.className = '';
                              }
                          } else {
                            if (inputs[0].checked == false) {
                                map.setLayoutProperty(id2, 'visibility', 'none');
                                this.className = '';
                            } else {
                                this.className = 'active';
                                map.setLayoutProperty(id2, 'visibility', 'visible');
                            }
                          }

                      });
                  };
              }
            }
          }
        };

        // Get the modal
        var modal = document.getElementById('myModal');

        // Get the button that opens the modal
        var btn = document.getElementById("myBtn");

        // Get the <span> element that closes the modal
        var span = document.getElementsByClassName("close")[0];

        // When the user clicks the button, open the modal
        btn.onclick = function() {
            modal.style.display = "block";
        }

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        var options = {
          dataType: 'xml',
          url: '/upload',
          beforeSubmit: showRequest,
          success: showResponse
        }

        $('#form_upload').submit(function() {
            $(this).ajaxSubmit(options);

            return false;
        });

        function showRequest(formData, jqForm, options) {
            // do something with formData
            return true;
        }

        function showResponse(response) {
            window.location = "http://{{ django_host }}:{{ django_port }}";
        }

        var inputs = document.querySelectorAll( '.input-design' );
        Array.prototype.forEach.call( inputs, function( input )
        {
        	var label	 = input.nextElementSibling,
        		labelVal = label.innerHTML;

        	input.addEventListener( 'change', function( e )
        	{
        		var fileName = '';
        		fileName = e.target.value.split( '\\' ).pop();

        		if( fileName ) {
        			label.querySelector( 'span' ).innerHTML = fileName;
                    document.getElementById('require').style.display = 'none';
                }
        		else
        			label.innerHTML = labelVal;
        	});
        });

        document.addEventListener("DOMContentLoaded", function() {
            var element = document.getElementById("fileGeoJSON");
            element.oninvalid = function(e) {
                e.target.setCustomValidity("");
                if (!e.target.validity.valid) {
                    document.getElementById('require').style.display = 'block';
                }
            };
            element.oninput = function(e) {
                e.target.setCustomValidity("");
            };
        })

        $('#fileGeoJSON').on("invalid", function(e) {
            e.preventDefault();
        });
    </script>
    <script type="text/javascript" src="{% static "map/menu.js" %}"></script>
</body>
</html>
